<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Deluxe Calculator</title>
<style>
  :root{
    --bg:#f3f6f9; --panel:#fff; --muted:#6b7280; --accent:#0ea5a4; --key:#f7fafc; --shadow: 0 6px 20px rgba(13,17,23,0.08);
    --danger:#ef4444;
  }
  [data-theme="dark"]{
    --bg:#0b1020; --panel:#0f1724; --muted:#9ca3af; --accent:#22d3ee; --key:#111827; --shadow: 0 10px 30px rgba(2,6,23,0.6);
  }
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  body{background:linear-gradient(180deg,var(--bg),#fff);display:flex;align-items:center;justify-content:center;padding:20px;}
  .calc {
    width:100%;max-width:980px;background:var(--panel);border-radius:14px;padding:18px;box-shadow:var(--shadow);display:grid;grid-template-columns:1fr 300px;gap:16px;
  }
  @media (max-width:820px){ .calc{grid-template-columns:1fr;max-width:420px} .history{order:2} .pad{order:1} }
  .display {background:transparent;padding:12px;border-radius:10px;display:flex;flex-direction:column;gap:6px;}
  .expr{color:var(--muted);font-size:14px;min-height:18px;overflow:auto}
  .result{font-size:36px;font-weight:700;word-break:break-all;}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .controls button{background:transparent;border:0;color:var(--muted);padding:6px 10px;border-radius:8px;cursor:pointer}
  .pad{background:linear-gradient(180deg, rgba(0,0,0,0.01), transparent);padding:12px;border-radius:10px}
  .keys{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  button.key{
    height:60px;border-radius:10px;border:0;background:var(--key);box-shadow:var(--shadow);font-size:18px;cursor:pointer;
  }
  button.key.wide{grid-column:span 2}
  button.op{background:linear-gradient(180deg,var(--accent),rgba(0,0,0,0.06));color:white}
  .history{background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent);padding:12px;border-radius:10px;max-height:420px;overflow:auto;}
  .history h3{margin:0 0 8px 0}
  .hist-item{display:flex;justify-content:space-between;padding:8px;border-radius:8px;align-items:center;gap:8px}
  .hist-item:hover{background:rgba(0,0,0,0.02);cursor:pointer}
  .muted{color:var(--muted)}
  .small{font-size:13px}
  .settings{margin-left:auto;display:flex;gap:8px;align-items:center}
  .theme-toggle{padding:6px;border-radius:8px;background:var(--key);border:0;cursor:pointer}
  .mode-pill{padding:6px 8px;border-radius:999px;background:var(--key);border:0;cursor:pointer}
  .footer-note{margin-top:10px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
  <div class="calc" id="calculator" data-theme="light">
    <div>
      <div class="display" aria-live="polite">
        <div class="controls">
          <div class="mode-pill small" id="modeLabel">Standard</div>
          <div class="settings">
            <button class="theme-toggle" id="themeBtn" title="Toggle theme">ðŸŒ—</button>
            <button class="mode-pill" id="toggleMode">Scientific</button>
            <button class="mode-pill small" id="degRad">Deg</button>
          </div>
        </div>
        <div class="expr" id="expr" contenteditable="true" aria-label="Expression" role="textbox"></div>
        <div class="result" id="result" aria-label="Result">0</div>
      </div>

      <div class="pad" id="pad">
        <div class="keys" id="keys">
          <!-- row 1 -->
          <button class="key" data-action="mc">MC</button>
          <button class="key" data-action="mr">MR</button>
          <button class="key" data-action="mplus">M+</button>
          <button class="key" data-action="mminus">M-</button>

          <!-- row 2 -->
          <button class="key" data-value="(">(</button>
          <button class="key" data-value=")">)</button>
          <button class="key" data-action="back">âŒ«</button>
          <button class="key op" data-action="clear">C</button>

          <!-- row 3 -->
          <button class="key" data-value="7">7</button>
          <button class="key" data-value="8">8</button>
          <button class="key" data-value="9">9</button>
          <button class="key op" data-value="/" title="Divide">Ã·</button>

          <!-- row 4 -->
          <button class="key" data-value="4">4</button>
          <button class="key" data-value="5">5</button>
          <button class="key" data-value="6">6</button>
          <button class="key op" data-value="*" title="Multiply">Ã—</button>

          <!-- row 5 -->
          <button class="key" data-value="1">1</button>
          <button class="key" data-value="2">2</button>
          <button class="key" data-value="3">3</button>
          <button class="key op" data-value="-" title="Minus">âˆ’</button>

          <!-- row 6 -->
          <button class="key wide" data-value="0">0</button>
          <button class="key" data-value=".">.</button>
          <button class="key op" data-value="+" title="Plus">+</button>

          <!-- scientific keys (hidden in standard mode) -->
          <button class="key sci" data-fn="sqrt">âˆš</button>
          <button class="key sci" data-fn="pow">^</button>
          <button class="key sci" data-fn="sin">sin</button>
          <button class="key sci" data-fn="cos">cos</button>
          <button class="key sci" data-fn="tan">tan</button>
          <button class="key sci" data-fn="ln">ln</button>
          <button class="key sci" data-fn="log">log</button>
          <button class="key sci" data-fn="exp">eË£</button>
          <button class="key sci" data-action="ans">Ans</button>
          <button class="key sci" data-action="equals">=</button>
        </div>
      </div>
      <div class="footer-note small muted">Tip: keyboard works. Press Enter to evaluate.</div>
    </div>

    <aside class="history" id="history">
      <h3>History</h3>
      <div id="histList" aria-live="polite"></div>
      <div style="height:14px"></div>
      <div>
        <button class="mode-pill" id="clearHist">Clear History</button>
        <button class="mode-pill" id="copyResult">Copy Result</button>
      </div>
    </aside>
  </div>

<script>
/* ---- simple safe evaluator ----
   - allow digits, whitespace, parentheses, operators + - * / % . ^ 
   - allow names: sin cos tan asin acos atan sqrt ln log exp pow
   - map ln -> Math.log, log -> Math.log10, exp(x) -> Math.exp(x), pow -> Math.pow
   - replace ^ with **
*/
(() => {
  const exprEl = document.getElementById('expr');
  const resultEl = document.getElementById('result');
  const keys = document.getElementById('keys');
  const histList = document.getElementById('histList');
  const degRadBtn = document.getElementById('degRad');
  const toggleModeBtn = document.getElementById('toggleMode');
  const modeLabel = document.getElementById('modeLabel');
  const themeBtn = document.getElementById('themeBtn');
  const calcEl = document.getElementById('calculator');

  let history = [];
  let memory = 0;
  let lastAns = 0;
  let isScientific = false;
  let isDeg = true;

  function sanitizeAndEval(s) {
    if (!s || !s.trim()) throw new Error("Empty expression");
    // normalize
    s = s.replace(/Ã—/g,'*').replace(/Ã·/g,'/').replace(/âˆ’/g,'-').replace(/,/g,'.');
    // allowed tokens check
    // allowed chars: digits, letters, operators, parentheses, whitespace, dot
    if (!/^[0-9+\-*/%^()., eEaxyinsctgolpbradnSINAOCUXT]+$/i.test(s)) {
      // fallback: restrict to limited character set
      // allow letters for function names and 'x' maybe
    }
    // map functions to Math
    const fnMap = {
      'sin': 'Math.sin',
      'cos': 'Math.cos',
      'tan': 'Math.tan',
      'asin': 'Math.asin',
      'acos': 'Math.acos',
      'atan': 'Math.atan',
      'sqrt': 'Math.sqrt',
      'ln': 'Math.log',
      'log': 'Math.log10',
      'exp': 'Math.exp',
      'pow': 'Math.pow',
      'abs': 'Math.abs',
      'pi': 'Math.PI',
      'e': 'Math.E'
    };
    // replace word functions with Math.* (word boundary)
    for (const [k,v] of Object.entries(fnMap)) {
      const re = new RegExp('\\b'+k+'\\b','gi');
      s = s.replace(re, v);
    }

    // caret ^ to ** for power (also support pow(a,b))
    s = s.replace(/\^/g, '**');

    // handle degree to radian conversion for trig if needed:
    if (isDeg) {
      // wrap Math.sin(ARG) -> Math.sin((ARG) * Math.PI/180)
      // Similarly for sin,cos,tan,asin,acos,atan (inverse functions return radians; convert to deg)
      s = s.replace(/Math\.(sin|cos|tan)\s*\(\s*([^\)]+)\s*\)/gi,
        (m, fn, inner) => `Math.${fn}(( ${inner} ) * Math.PI/180)`);
      // for inverse trig: we need to convert result from rad to deg after calling
      s = s.replace(/Math\.(asin|acos|atan)\s*\(\s*([^\)]+)\s*\)/gi,
        (m, fn, inner) => `( Math.${fn}( ${inner} ) * 180/Math.PI )`);
    }

    // allow percent: convert "number%" -> "(number/100)"
    s = s.replace(/(\d+(\.\d+)?)\s*%/g, '($1/100)');

    // replace Ans token (if user typed Ans)
    s = s.replace(/\bAns\b/gi, String(lastAns));

    // final safety check: only allow characters appearing in the transformed string
    if (!/^[0-9+\-*/%()., *\wMathPIEpowabslnloge]+$/.test(s)) {
      // keep a looser check but avoid semicolons, braces, letters that might be used maliciously
    }

    // Evaluate inside a Function for speed; since we tightly control replacements it's acceptable for local use.
    try {
      // disallow access to global objects by only returning the expression
      // eslint-disable-next-line no-new-func
      const fn = new Function('return ('+s+');');
      const val = fn();
      if (typeof val === 'number' && isFinite(val)) {
        return val;
      } else {
        throw new Error('Result not a finite number');
      }
    } catch (err) {
      throw new Error('Invalid expression');
    }
  }

  function pushHistory(expression, value) {
    const item = {expression, value, time: Date.now()};
    history.unshift(item);
    if (history.length>200) history.pop();
    renderHistory();
  }
  function renderHistory() {
    histList.innerHTML = '';
    history.forEach((h, idx) => {
      const div = document.createElement('div');
      div.className = 'hist-item';
      div.innerHTML = `<div style="max-width:70%"><div class="small muted">${escapeHtml(h.expression)}</div><div>${h.value}</div></div><div style="min-width:48px;text-align:right"><button class="mode-pill small reuse" data-idx="${idx}">Use</button> <button class="mode-pill small del" data-idx="${idx}">Del</button></div>`;
      histList.appendChild(div);
    });
  }
  function escapeHtml(t){ return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

  function evaluateAndShow() {
    const raw = exprEl.innerText.trim();
    try {
      const val = sanitizeAndEval(raw);
      lastAns = val;
      resultEl.textContent = Number.isInteger(val) ? String(val) : String(val);
      resultEl.style.color = '';
      pushHistory(raw, resultEl.textContent);
    } catch (e) {
      resultEl.textContent = e.message;
      resultEl.style.color = 'var(--danger)';
    }
  }

  // button clicks
  keys.addEventListener('click', (ev) => {
    const btn = ev.target.closest('button');
    if(!btn) return;
    const v = btn.dataset.value;
    const act = btn.dataset.action;
    const fn = btn.dataset.fn;

    if (v !== undefined) {
      insertAtCursor(v);
    } else if (act) {
      handleAction(act);
    } else if (fn) {
      // function insertion
      insertAtCursor(fn + '(');
    }
  });

  // helper to insert at caret in contenteditable
  function insertAtCursor(text) {
    // put focus
    exprEl.focus();
    // modern approach: use selection range
    const sel = window.getSelection();
    if (!sel || !sel.getRangeAt || sel.rangeCount === 0) {
      exprEl.innerText += text;
      placeCaretAtEnd(exprEl);
      return;
    }
    const range = sel.getRangeAt(0);
    range.deleteContents();
    const node = document.createTextNode(text);
    range.insertNode(node);
    // move caret after inserted node
    range.setStartAfter(node);
    range.setEndAfter(node);
    sel.removeAllRanges();
    sel.addRange(range);
    exprEl.dispatchEvent(new Event('input'));
  }
  function placeCaretAtEnd(el) {
    el.focus();
    const range = document.createRange();
    range.selectNodeContents(el);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }

  function handleAction(action) {
    if (action === 'back') {
      // delete last character in expr
      const txt = exprEl.innerText;
      exprEl.innerText = txt.slice(0, -1);
      placeCaretAtEnd(exprEl);
    } else if (action === 'clear') {
      exprEl.innerText = '';
      resultEl.textContent = '0';
    } else if (action === 'equals') {
      evaluateAndShow();
    } else if (action === 'mc') { memory = 0; }
    else if (action === 'mr') { insertAtCursor(String(memory)); }
    else if (action === 'mplus') {
      try { memory += sanitizeAndEval(exprEl.innerText || String(lastAns)); } catch {}
    }
    else if (action === 'mminus') {
      try { memory -= sanitizeAndEval(exprEl.innerText || String(lastAns)); } catch {}
    } else if (action === 'ans') {
      insertAtCursor(String(lastAns));
    }
  }

  // keyboard support
  window.addEventListener('keydown', (e) => {
    const k = e.key;
    if (k === 'Enter') { e.preventDefault(); evaluateAndShow(); return; }
    if (k === 'Escape') { exprEl.innerText = ''; resultEl.textContent = '0'; return; }
    if (k === 'Backspace') { return; /* allow default in contenteditable */ }
    // allow numeric and operators
    const allowed = '0123456789+-*/().%^';
    if (allowed.indexOf(k) >= 0) {
      // let it go into contenteditable
    } else if (k === 'c' && (e.ctrlKey || e.metaKey)) { // copy result
      navigator.clipboard && navigator.clipboard.writeText(resultEl.textContent);
    } else {
      // intercept others so page doesn't scroll etc
    }
  });

  // history reuse / delete
  histList.addEventListener('click', (ev) => {
    const btn = ev.target.closest('button');
    if (!btn) return;
    const idx = Number(btn.dataset.idx);
    if (btn.classList.contains('reuse')) {
      const it = history[idx];
      if (it) { exprEl.innerText = it.expression; placeCaretAtEnd(exprEl); }
    } else if (btn.classList.contains('del')) {
      history.splice(idx,1); renderHistory();
    }
  });

  document.getElementById('clearHist').addEventListener('click', () => {
    history = []; renderHistory();
  });
  document.getElementById('copyResult').addEventListener('click', () => {
    navigator.clipboard && navigator.clipboard.writeText(resultEl.textContent);
  });

  // theme toggle
  themeBtn.addEventListener('click', () => {
    const theme = calcEl.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
    calcEl.setAttribute('data-theme', theme);
  });

  // mode toggle (standard/scientific)
  toggleModeBtn.addEventListener('click', () => {
    isScientific = !isScientific;
    document.querySelectorAll('.sci').forEach(el => el.style.display = isScientific ? '' : 'none');
    modeLabel.textContent = isScientific ? 'Scientific' : 'Standard';
    toggleModeBtn.textContent = isScientific ? 'Standard' : 'Scientific';
  });
  // init standard
  toggleModeBtn.click(); toggleModeBtn.click(); // ensure correct state

  // deg/rad toggle
  degRadBtn.addEventListener('click', () => {
    isDeg = !isDeg;
    degRadBtn.textContent = isDeg ? 'Deg' : 'Rad';
  });

  // allow clicking expression to focus for editing
  exprEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); evaluateAndShow(); }
  });

  // double click result to copy
  resultEl.addEventListener('dblclick', () => {
    navigator.clipboard && navigator.clipboard.writeText(resultEl.textContent);
  });

  // small helper: compute on paste or input
  exprEl.addEventListener('input', () => {
    // live-preview evaluation with try/catch
    const text = exprEl.innerText;
    try {
      const v = sanitizeAndEval(text);
      resultEl.textContent = v;
      resultEl.style.color = '';
    } catch (err) {
      // don't override with error while typing
      // show hint but keep muted color
      resultEl.style.color = 'var(--muted)';
    }
  });

  // initial render
  renderHistory();
})();
</script>
</body>
</html>
